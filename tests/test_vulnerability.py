"""Tests for vulnerability scanner."""

import pytest
from unittest.mock import patch, MagicMock

from supply_chain_analyzer.scanners.vulnerability import VulnerabilityScanner
from supply_chain_analyzer.core.config import Config
from supply_chain_analyzer.core.models import Dependency, Ecosystem, Severity


class TestVulnerabilityScanner:
    """Tests for VulnerabilityScanner."""
    
    def setup_method(self):
        """Set up test fixtures."""
        self.config = Config()
        self.scanner = VulnerabilityScanner(self.config)
    
    def test_severity_from_cvss(self):
        """Test severity level from CVSS score."""
        assert Severity.from_cvss(9.5) == Severity.CRITICAL
        assert Severity.from_cvss(8.0) == Severity.HIGH
        assert Severity.from_cvss(5.5) == Severity.MEDIUM
        assert Severity.from_cvss(2.0) == Severity.LOW
        assert Severity.from_cvss(0) == Severity.UNKNOWN
    
    def test_scan_empty_dependencies(self):
        """Test scanning with no dependencies."""
        result = self.scanner.scan([])
        assert result == {}
    
    @patch("httpx.Client.post")
    def test_scan_with_mock_response(self, mock_post):
        """Test scanning with mocked OSV response."""
        # Mock OSV API response
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "vulns": [
                {
                    "id": "PYSEC-2021-001",
                    "summary": "Test vulnerability",
                    "details": "A test vulnerability for testing",
                    "severity": [{"type": "CVSS_V3", "score": "CVSS:3.1/AV:N/AC:L"}],
                    "affected": [],
                    "references": [],
                }
            ]
        }
        mock_post.return_value = mock_response
        
        deps = [
            Dependency(name="test-package", version="1.0.0", ecosystem=Ecosystem.PIP)
        ]
        
        result = self.scanner.scan(deps)
        
        assert len(result) == 1
        assert "pip:test-package@1.0.0" in result
        assert result["pip:test-package@1.0.0"][0].id == "PYSEC-2021-001"
    
    @patch("httpx.Client.post")
    def test_scan_with_no_vulnerabilities(self, mock_post):
        """Test scanning package with no vulnerabilities."""
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {"vulns": []}
        mock_post.return_value = mock_response
        
        deps = [
            Dependency(name="safe-package", version="1.0.0", ecosystem=Ecosystem.PIP)
        ]
        
        result = self.scanner.scan(deps)
        
        # No vulnerabilities means empty result
        assert result == {}
    
    @patch("httpx.Client.post")
    def test_scan_handles_api_error(self, mock_post):
        """Test that API errors are handled gracefully."""
        import httpx
        mock_post.side_effect = httpx.HTTPError("API Error")
        
        deps = [
            Dependency(name="test-package", version="1.0.0", ecosystem=Ecosystem.PIP)
        ]
        
        # Should not raise, should return empty
        result = self.scanner.scan(deps)
        assert result == {}
